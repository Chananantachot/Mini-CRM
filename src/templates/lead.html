{% extends "layout.html" %}
{% block styles %}
 <style>
.call-panel {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 300px;
  background: #fff;
  box-shadow: 0 0 15px rgba(0,0,0,0.2);
  border-radius: 12px;
  padding: 16px;
  font-family: "Segoe UI", sans-serif;
  z-index: 9999;
  display: none; /* toggle to 'block' when call comes in */
}

.call-info {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.caller-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
}

.caller-name {
  font-weight: 600;
  margin: 0;
}

.call-status {
  color: gray;
  font-size: 14px;
  margin: 4px 0 0;
}

.call-actions {
  display: flex;
  justify-content: space-between;
}

.btn {
  flex: 1;
  margin: 0 4px;
  padding: 10px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  font-size: 14px;
}

.accept {
  background: #28a745;
  color: white;
}

.decline {
  background: #dc3545;
  color: white;
}

div.transbox {
  background-color: rgba(255, 255, 255, 0.4);
  -webkit-backdrop-filter: blur(5px);
  backdrop-filter: blur(5px);
  height: 100%;	
  width: 100%;
  font-weight: bold;
}

.btn {
  flex: 1;
  margin: 0 4px;
  padding: 7px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  font-size: 12px;
}
</style>
{% endblock %}
{% block content %}

<table id="gridLeads" class="table table-striped table-bordered">
</table>
<div id="pager"></div>
<br />
<table id="gridProdsInterest" class="table table-striped table-bordered">
</table>
<div id="_pager"></div>
<div id="callBackdrop" class="transbox"></div>
<div id="incomingCallPanel" class="call-panel">
  <div class="call-info">
    <img src="{{ url_for('static', filename='avatar_saleperson.png') }}" style="height:50px;max-width: 100%;" />
    <div>
      <p class="caller-name">A sales rep is</p>
      <p class="call-status">üìû Calling you...</p>
    </div>
  </div>
  <div class="call-actions">
    <button id="acceptBtn" class="btn accept">‚úÖ Answer</button>
    <button id="declineBtn" class="btn decline">‚ùå End</button>
  </div>
</div>
{% endblock %}
{% block scripts %}
<!-- REQUIRED: jQuery UI JS for Datepicker functionality -->
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://unpkg.com/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"></script>
<script src="https://unpkg.com/bootstrap-datepicker@1.9.0/dist/locales/bootstrap-datepicker.ar.min.js" charset="UTF-8"></script>
 <script src="{{ url_for('static', filename='lead.js') }}"></script>
  <script src="{{ url_for('static', filename='product.js') }}"></script>
<script>
  "use strict";
  var calling = false;
  var url = window.location.href;
  const match = url.match(/\/customers\/([0-9a-fA-F-]{36})?/);
  const matchRoom = url.match(/\/lead\/call\/answer\/([0-9a-fA-F-]{36})?/);
  const room = matchRoom ? matchRoom[1] : null;
  if (room)
    showIncomingCallPanel('Someone')

  const custId = match ? match[1] : null;
  if (custId)
    loadLeads(custId)
  else
    loadLeads()

 //loadProdsInterest()
// Call this function when the incoming call event is received
function showIncomingCallPanel(callerName) {
  document.querySelector('.caller-name').textContent = callerName;
  $('#incomingCallPanel').show();
}

// Accept/Decline actions
document.getElementById('acceptBtn').onclick = () => {
  calling = true;
  answerCall(room);
 
  $('#acceptBtn').hide();
};

document.getElementById('declineBtn').onclick = () => {
  if (calling)
    endCall(room)
  else  
    declineCall(room)

   fetch('/end_call', {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ lead_id: room })
    }).then(res => {
      if (res.ok || res.status == 404) {
         $('#incomingCallPanel').hide();
        setTimeout(() => {
          window.close();
        }, 4000); // Closes after 3 seconds
      } 
  });  
};

window.onunload = function(){
  window.opener.location.reload();
};
</script>
{% endblock %}